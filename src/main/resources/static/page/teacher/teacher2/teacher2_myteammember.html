<!DOCTYPE html>
<html class="x-admin-sm" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>信阳农林学院毕业论文指导过程管理系统</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
    <link rel="stylesheet" href="/css/font.css">
    <link rel="stylesheet" href="/css/xadmin.css">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.min.css" rel="stylesheet">
    <link href="/lib/layui/css/layui.css" rel="stylesheet">
    <link href="/css/materialdesignicons.min.css" rel="stylesheet">
    <script src="/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="/js/xadmin.js"></script>
    <script type="text/javascript" src="/js/excel.js"></script>
    <script type="text/javascript" src="/js/own/public.js"></script>
    <script type="text/javascript" src="/js/own/teacher4.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<style type="text/css">
    .layui-table-body {
        overflow-x: hidden;
    }
</style>
<body>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <!--自定义页面内容-->

            <!--tips-->
            <div class="layui-card">
                <div class="layui-card-body ">
                    <blockquote class="layui-elem-quote">
                        可点击成员小组单元格,直接修改成员所属小组!
                    </blockquote>
                </div>
            </div>
            <!--END tips-->

            <!--小组-->
            <div style="padding: 20px; background-color: #887777;">
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md12">
                        <div class="layui-card">
                            <div class="layui-card-body" style="display:inline-block;width: 100%">
                                <!--核心元素-->
                                <fieldset class="layui-elem-field">
                                    <legend style="color: black;">教师</legend>
                                    <div class="layui-field-box">
                                        <!--教师面板元素-->
                                        <div class="layui-collapse" lay-accordion id="teamteacherGroup" lay-filter="teamgroupfilter">
                                            <div class="layui-colla-item" id="teamteacher1">
                                                <h2 class="layui-colla-title">
                                                    <p style="float: left" id="teamteaName1"></p>
                                                </h2>
                                                <div class="layui-colla-content">
                                                    <!--显示教师信息的表格-->
                                                    <table class="layui-hide" id="teamteachertable1" lay-filter="table"></table>
                                                    <!--END表格-->
                                                </div>
                                            </div>
                                        </div>
                                        <!--END面板元素-->
                                    </div>
                                </fieldset>
                                <hr class="layui-bg-black">
                                <fieldset class="layui-elem-field">
                                    <legend>学生</legend>
                                    <div class="layui-field-box">
                                        <!--学生面板元素-->
                                        <div class="layui-collapse" lay-accordion id="teamstuGroup" lay-filter="teamgroupfilter">
                                            <div class="layui-colla-item" id="teamstu1">
                                                <h2 class="layui-colla-title">
                                                    <p style="float: left" id="teamstuName1"></p>
                                                </h2>
                                                <div class="layui-colla-content">
                                                    <!--显示教师信息的表格-->
                                                    <table class="layui-hide" id="teamstutable1" lay-filter="table"></table>
                                                    <!--END表格-->
                                                </div>
                                            </div>
                                        </div>
                                        <!--END面板元素-->
                                    </div>
                                </fieldset>
                                <!--END核心元素-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--END小组-->
            <!--END自定义页面内容-->
        </div>
    </div>
</div>
</div>
<!--第一列序号-->
<script type="text/html" id="xuhao">
    {{d.LAY_TABLE_INDEX+1}}
</script>

<!--修改小组时所需元素-->
<form class="layui-form" id="updatateamdiv" style="display: none;font-size: 20px">
    <div class="layui-form-item">
        <br>
        <label class="layui-form-label" style="width: 200px">id：</label>
        <div class="layui-input-block">
            <input type="text" name="personid" disabled id="personid" lay-verify="required" class="layui-input" style="width: 450px">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width:200px">姓名：</label>
        <div class="layui-input-block">
            <input type="text" name="personname" id="personname"
                   style="width: 450px"
                   class="layui-input" disabled>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width:200px;float: left;">所属小组：</label>
        <div class="layui-input-block">
            <input type="text" name="teamlist" id="teamlist" placeholder="请直接选择不要自己输入"
                   style="width: 450px"
                   class="layui-input" list="getteamlist" onfocus="createteamlist();" onblur="deleteteamlist();" autocomplete="false">
            <datalist id="getteamlist"></datalist>
        </div>
        </div>
    </div>
    <div class="layui-form-item" style="display: none">
        <label class="layui-form-label" style="width:200px;float: left;">所属小组：</label>
        <div class="layui-input-block">
            <input type="text" name="" id="role"
                   style="width: 450px"
                   class="layui-input">
        </div>
    </div>
    </div>
    <div class="layui-form-item" style="margin-left: 150px">
        <div class="layui-input-block">
            <button type="button" class="layui-btn layui-btn-lg" onclick="updatateam();">确认修改</button>
            <button type="button" class="layui-btn layui-btn-lg layui-btn-primary" onclick="closethis();">取消修改</button>
        </div>
    </div>
</form>


<script>
    layui.use(['form', 'layer', 'util', 'transfer', 'element','table'], function () {
        var form = layui.form
            , layer = layui.layer
            , util = layui.util
            , transfer = layui.transfer
            ,table=layui.table
            , element = layui.element;

        //加载已经存在的小组
        $.ajax({
            url: "/team/allTeam",
            type: 'post',
            async: false,
            cache: false,
            success: function (result) {
                var resultteam=eval(result);
                $('#teamteaName1').html(resultteam.data[0].tname);
                $('#teamstuName1').html(resultteam.data[0].tname);
                layui.element.render();
                /*教师面板渲染*/
                for (i=1;i<resultteam.data.length;i++){
                    var newid=Number(i)+Number(1);
                    //新建小组元素
                    $('#teamteacher'+i).after( "<div class=\"layui-colla-item\" id=\"teamteacher"+newid+"\">\n" +
                        "                                                <h2 class=\"layui-colla-title\">\n" +
                        "                                                    <p style=\"float: left\" id=\"teamteaName"+newid+"\"></p>\n" +
                        "                                                </h2>\n" +
                        "                                                <div class=\"layui-colla-content\">\n" +
                        "                                                    <!--显示教师信息的表格-->\n" +
                        "                                                    <table class=\"layui-hide\" id=\"teamteachertable"+newid+"\" lay-filter=\"table\"></table>\n" +
                        "                                                    <!--END表格-->\n" +
                        "                                                </div>\n" +
                        "                                            </div>");
                    /*END教师*/
                    $('#teamteaName'+newid).html(resultteam.data[i].tname);
                    layui.element.render();
                }
                    /*学生面板渲染*/
                for (i=1;i<resultteam.data.length;i++){
                        var newid=Number(i)+Number(1);
                        //新建小组元素
                        $('#teamstu'+i).after("<div class=\"layui-colla-item\" id=\"teamstu"+newid+"\">\n" +
                            "                                                <h2 class=\"layui-colla-title\">\n" +
                            "                                                    <p style=\"float: left\" id=\"teamstuName"+newid+"\"></p>\n" +
                            "                                                </h2>\n" +
                            "                                                <div class=\"layui-colla-content\">\n" +
                            "                                                    <!--显示教师信息的表格-->\n" +
                            "                                                    <table class=\"layui-hide\" id=\"teamstutable"+newid+"\" lay-filter=\"table\"></table>\n" +
                            "                                                    <!--END表格-->\n" +
                            "                                                </div>\n" +
                            "                                            </div>");
                        /*END学生*/
                    $('#teamstuName'+newid).html(resultteam.data[i].tname);
                    layui.element.render();
                }
            }
        });

        element.on('collapse(teamgroupfilter)', function (data) {
            /*console.log(data.show); //得到当前面板的展开状态，true或者false
            console.log($(data.title.html()).attr('id')); //得到当前点击面板的标题区域DOM对象
            console.log(data.content); //得到当前点击面板的内容区域DOM对象*/
            var role=$(data.title.html()).attr('id').substring(4,7);
            var titleid=$(data.title.html()).attr('id');
            var teamName=$("#"+titleid+"").text();
            var lastid=$(data.title.html()).attr('id').substring(11,12);
            if (role=="tea") {
                var tableName="teamteachertable"+lastid;
                teamteatablerender(tableName,teamName);
            }else if(role=="stu") {
                var tableName="teamstutable"+lastid;
                teamstutablerender(tableName,teamName);
            }
        });

        /*监听小组信息变更*/
        table.on('tool(table)', function(obj){ //注：tool 是工具条事件名，table 是 table 原始容器的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的 DOM 对象（如果有的话）
            /*console.log(data,layEvent,tr);*/
            if (layEvent=="changeteateam"){
                layer.open({
                    type: 1
                    ,title: false //不显示标题栏
                    ,closeBtn: true
                    ,area: ['700px', '300px']
                    ,shade: 0.8
                    ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
                    ,btnAlign: 'c'
                    ,moveType: 1 //拖拽模式，0或者1
                    ,content: $('#updatateamdiv')
                });
                $('#personid').val(data.teaId);
                $('#personname').val(data.teaName);
                $('#role').val("tea");
            }else  if (layEvent=="changestuteam"){
                layer.open({
                    type: 1
                    ,title: false //不显示标题栏
                    ,closeBtn: true
                    ,area: ['700px', '300px']
                    ,shade: 0.8
                    ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
                    ,btnAlign: 'c'
                    ,moveType: 1 //拖拽模式，0或者1
                    ,content: $('#updatateamdiv')
                });
                /*重新赋学生的值,适应学生表格点击事件*/
                $('#personid').val(data.stuId);
                $('#personname').val(data.stuName);
                $('#role').val("stu");
            }
        });

    });

    /*组内教师表格渲染*/
    function teamteatablerender(tableName,teamName) {
        var $ = layui.jquery;
        var table = layui.table;
        /*console.log('#'+tableName+'');
        console.log(teamName);*/
        var teatablerender=table.render({
            elem: '#'+tableName
            /*,id:'teatable'*/
            ,url:'/teacher/selectTeacherByTeam'
            ,where:{teamName:''+teamName+''}
            ,contentType: 'application/json'
            ,method:'post'
            ,response:{
                statusName: 'res'
                ,statusCode:true
            }
           /* ,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增*/
            ,cols: [[
                ,{title: '序号',templet: '#xuhao',width:'10%'}
                ,{field:'teaId', title:'教职工编号',sort: true,width:'10%'}
                ,{field:'teaName', title:'姓名',width:'20%'}
                ,{field:'dept', title:'系别',width:'15%'}
                ,{field:'ptitle', title:'职称',width:'15%'}
                ,{field:'teaPhone', title:'电话',width:'10%'}
                ,{field:'teaTeam', title:'所属小组',event:'changeteateam',width:'30%'}
            ]]
        });
        return teatablerender;
    }
    /*END组内教师表格渲染*/
    /*组内学生渲染*/
    function teamstutablerender(tableName,teamName) {
        var $ = layui.jquery;
        var table = layui.table;
       var stutablerender=table.render({
            elem: '#'+tableName
            /*,id:'teatable'*/
            ,url:'/student/selectStudentByTeam'
            ,where:{teamName:''+teamName+''}
            ,contentType: 'application/json'
            ,method:'post'
            ,response:{
                statusName: 'res'
                ,statusCode:true
            }
            ,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,cols: [[
                ,{title: '序号',templet: '#xuhao',width:'10%'}
                ,{field:'stuId', title:'学号',sort: true,width:'10%'}
                ,{field:'stuName', title:'姓名',width:'10%'}
                ,{field:'dept', title:'系别',width:'15%'}
                ,{field:'zhuanye', title:'专业',width:'15%'}
                ,{field:'stuPhone', title:'电话',width:'15%'}
                ,{field:'stuTeam', title:'所属小组',width:'35%',event:'changestuteam'}
            ]]
        });
    }
    /*END组内学生渲染*/
    /*关闭打开的窗口*/
    function closethis() {
        var layer=layui.layer;
        layer.closeAll();
    }
    /*END关闭*/
    /*新建修改所属小组时所需的list*/
    function createteamlist() {
        var layer=layui.layer;
        $.ajax({
            url: "/team/allTeam",
            type: 'post',
            async: false,
            cache: false,
            success: function (result) {
                /*var jsonAllCateGory = eval(resultAllCateGory);*/
                if (true == (result.res)) {
                    //i是list的长度
                    var i = result.data.length;
                    for (j = 0; j < i; j++) {
                        $("#getteamlist").append("<option>" + result.data[j].tname + "</option>");
                    }
                }else {
                    layer.msg("数据接口异常,请稍后再试!",{icon:5})
                }
            }
        });
    }
    /*END新建list*/
    /*失去焦点就删除option*/
    function deleteteamlist() {
        $("#getteamlist").empty();
    }
    /*END删除option*/
    /*提交修改小组信息*/
    function updatateam() {
        var layer=layui.layer;
        var data={};
        var role=$('#role').val();
        console.log(role);
        if (role=="tea"){
            data["teaId"]=[];
            data["teaId"].push($('#personid').val());
            data["teaTeam"]=$('#teamlist').val();
            $.ajax({
                url: "/teacher/updateTeacherTeam",
                type: 'post',
                contentType: 'application/json;charset=UTF-8',
                dataType: 'json',
                data:JSON.stringify(data),
                async: false,
                cache: false,
                success: function (result) {
                    if (true == (result.res)) {
                        window.location.reload();
                    }else {
                        layer.msg("数据接口异常,请稍后再试!",{icon:5})
                    }
                }
            });
        }else if (role=="stu") {
            data["stuId"] = [];
            data["stuId"].push($('#personid').val());
            data["stuTeam"] = $('#teamlist').val();
            $.ajax({
                url: "/student/updateStudentTeam",
                type: 'post',
                contentType: 'application/json;charset=UTF-8',
                dataType: 'json',
                data: JSON.stringify(data),
                async: false,
                cache: false,
                success: function (result) {
                    if (true == (result.res)) {
                        window.location.reload();
                    } else {
                        layer.msg("数据接口异常,请稍后再试!", {icon: 5})
                    }
                }
            });
        }
    }
    /*END提交修改*/
</script>


</body>
</html>